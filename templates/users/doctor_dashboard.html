{% extends "base.html" %}

{% block content %}
<div class="container mt-5">

  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-primary">Дашборд лікаря</h1>
    <p class="lead text-secondary">{{ doctor.first_name }} {{ doctor.last_name }} — {{ doctor.specialization }}</p>
  </div>

  <div class="card shadow-lg rounded-4 mb-5 p-4 border-primary border-2">
    <form method="get" class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
      <label for="user_select" class="form-label fw-semibold mb-0">Виберіть пацєнта:</label>
      <select name="user_id" id="user_select" class="form-select w-auto" onchange="this.form.submit()">
        <option value="">--Оберіть пацєнта--</option>
        {% for user in users %}
          <option value="{{ user.id }}" {% if selected_user and selected_user.id == user.id %}selected{% endif %}>
            {{ user.username }}
          </option>
        {% endfor %}
      </select>
      {% if selected_user %}
        <div class="mt-2 mt-md-0 ms-md-3">
          <a href="{% url 'users:doctor-dashboard' %}" class="btn btn-outline-danger btn-sm fw-bold">Скинути вибір</a>
        </div>
      {% endif %}
    </form>
  </div>

  {% if selected_user %}
    <h2 class="mb-4 text-primary fw-bold border-bottom pb-2">Улюбленці користувача: {{ selected_user.username }}</h2>

    {% if pets %}
      {% for pet in pets %}
        <div class="card shadow-lg rounded-4 mb-4 border-info border-2">
          <div class="card-body p-4">

            <h3 class="card-title text-success fw-bold">{{ pet.nickname }} ({{ pet.age }} років)</h3>
            <p class="text-muted mb-3"><strong>Власник:</strong> {{ pet.owner.username }}</p>

            <a href="{% url 'pet_health_info:pet-health-create' %}?pet_id={{ pet.id }}" class="btn btn-primary btn-sm mb-4 fw-semibold">Додати рекомендацію</a>

            <h5 class="text-info fw-bold border-bottom pb-1 mb-3">Медична карта</h5>
            {% if pet.pet_info.exists %}
              <ul class="list-group list-group-flush mb-4">
                {% for info in pet.pet_info.all %}
                  <li class="list-group-item shadow-sm rounded-3 mb-2 d-flex justify-content-between align-items-start">
                    <div>
                      <p><strong>Діагноз:</strong> {{ info.diagnosis }}</p>
                      <p><strong>Рекомендації:</strong> {{ info.recommendation }}</p>
                      <p><strong>Лікар:</strong> {{ info.doctor.first_name }} {{ info.doctor.last_name }}</p>
                    </div>
                    <div>
                      <a href="{% url 'pet_health_info:pet-health-delete' info.id %}" class="btn btn-sm btn-outline-danger">Видалити</a>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-4">Медична інформація відсутня.</p>
            {% endif %}

            <h5 class="text-warning fw-bold border-bottom pb-1 mb-3">Операції</h5>
            <a href="{% url 'pet:operation-create' %}?pet_id={{ pet.id }}" class="btn btn-warning btn-sm mb-3 fw-bold">Додати операцію</a>
            {% if pet.pet_operations.exists %}
              <ul class="list-group list-group-flush">
                {% for operation in pet.pet_operations.all %}
                  <li class="list-group-item shadow-sm rounded-3 mb-2">
                    <p><strong>Дата:</strong> {{ operation.date|date:"d.m.Y H:i" }}</p>
                    <p><strong>Опис:</strong> {{ operation.description }}</p>
                    <p><strong>Лікарі:</strong>
                      {% for doctor in operation.doctors.all %}
                        {{ doctor.first_name }} {{ doctor.last_name }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    </p>

                    <div class="mt-3 d-flex flex-wrap gap-2">
                      <a href="{% url 'pet:operation-detail' operation.id %}" class="btn btn-info btn-sm fw-semibold">Деталі</a>
                      <a href="{% url 'pet:operation-update' operation.id %}" class="btn btn-secondary btn-sm fw-semibold">Редагувати</a>
                      <a href="{% url 'pet:operation-delete' operation.id %}" class="btn btn-danger btn-sm fw-semibold">Видалити</a>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">Операцій ще не було.</p>
            {% endif %}

          </div>
        </div>
      {% endfor %}

      {% if pets.has_other_pages %}
      <nav aria-label="Пагінація улюбленців">
        <ul class="pagination justify-content-center mt-3">
          {% if pets.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?user_id={{ selected_user.id }}&page={{ pets.previous_page_number }}">← Попередня</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">← Попередня</span></li>
          {% endif %}

          {% for num in pets.paginator.page_range %}
            <li class="page-item {% if pets.number == num %}active{% endif %}">
              <a class="page-link" href="?user_id={{ selected_user.id }}&page={{ num }}">{{ num }}</a>
            </li>
          {% endfor %}

          {% if pets.has_next %}
            <li class="page-item">
              <a class="page-link" href="?user_id={{ selected_user.id }}&page={{ pets.next_page_number }}">Наступна →</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Наступна →</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    {% else %}
      <p class="text-muted">У цього користувача немає улюбленців.</p>
    {% endif %}
  {% endif %}

</div>
{% endblock %}